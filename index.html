<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système de Facturation Ultra-Avancé</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header-content p {
            opacity: 0.9;
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .business-selector-header {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            min-width: 140px;
            text-align: center;
        }

        .business-selector-header:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .business-dropdown {
            position: relative;
            display: inline-block;
        }

        .business-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            border-radius: 6px;
            z-index: 1000;
            margin-top: 5px;
        }

        .business-dropdown-content.show {
            display: block;
        }

        .business-option {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            border-radius: 6px;
            margin: 4px;
            transition: all 0.3s ease;
            font-size: 13px;
        }

        .business-option:hover {
            background-color: #f1f1f1;
        }

        .business-option.active {
            background-color: #667eea;
            color: white;
        }

        .connection-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .connected {
            background: #28a745;
            color: white;
        }

        .disconnected {
            background: #dc3545;
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 450px 1fr;
            min-height: 800px;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 25px;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
            max-height: 800px;
        }

        .dashboard-widgets {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .widget {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .widget h4 {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .widget .value {
            font-size: 18px;
            font-weight: 700;
            color: #495057;
        }

        .widget.revenue .value {
            color: #28a745;
        }

        .widget.pending .value {
            color: #ffc107;
        }

        .widget.overdue .value {
            color: #dc3545;
        }

        .quick-actions {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .quick-actions h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .quick-action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .quick-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .quick-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .ai-suggestions {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .ai-suggestions h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .suggestion-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 11px;
        }

        .suggestion-item:last-child {
            margin-bottom: 0;
        }

        .config-section {
            background: #e3f2fd;
            color: #0c5460;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 3px solid #2196f3;
        }

        .config-section h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .config-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .config-btn {
            background: white;
            color: #2196f3;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .config-btn:hover {
            background: #f1f3f4;
        }

        .google-integration {
            background: #4285f4;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .google-integration h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .google-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .google-btn {
            background: white;
            color: #4285f4;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .google-btn:hover {
            background: #f1f3f4;
        }

        .google-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tab-navigation {
            display: flex;
            margin-bottom: 20px;
            background: #e9ecef;
            border-radius: 8px;
            padding: 4px;
            flex-wrap: wrap;
        }

        .tab-btn {
            flex: 1;
            padding: 6px 8px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 60px;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            margin-bottom: 20px;
        }

        .form-section h3 {
            color: #495057;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            color: #495057;
            font-weight: 500;
            font-size: 12px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-block {
            width: 100%;
            margin-bottom: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 11px;
        }

        .templates-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .template-category {
            margin-bottom: 15px;
        }

        .template-category h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 12px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 4px;
        }

        .template-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 4px 0;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #667eea;
            transition: all 0.3s ease;
        }

        .template-item:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }

        .template-info {
            flex: 1;
        }

        .template-info strong {
            font-size: 11px;
            color: #495057;
        }

        .template-info small {
            display: block;
            color: #6c757d;
            font-size: 10px;
        }

        .template-price {
            font-weight: 600;
            color: #28a745;
            font-size: 12px;
            margin-right: 8px;
        }

        .add-template-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.3s ease;
        }

        .add-template-btn:hover {
            background: #5a6fd8;
            transform: scale(1.05);
        }

        .smart-features {
            background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .smart-features h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .smart-feature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .smart-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .smart-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.02);
        }

        .preview-area {
            padding: 25px;
            background: white;
            overflow-y: auto;
            max-height: 800px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .preview-header h2 {
            color: #495057;
            font-size: 18px;
        }

        .preview-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .document-preview {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: scale(0.75);
            transform-origin: top left;
            width: 133%;
            margin-bottom: 20px;
        }

        .document-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            position: relative;
        }

        .document-header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(20px, -20px);
        }

        .header-content-doc {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 1;
        }

        .company-info h3 {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .company-info p {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .document-title h3 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .document-number {
            font-size: 12px;
            opacity: 0.9;
        }

        .document-body {
            padding: 20px;
            font-size: 10px;
        }

        .parties-section {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .party-info {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            border-left: 3px solid #667eea;
            flex: 1;
        }

        .party-info h4 {
            color: #667eea;
            font-size: 12px;
            margin-bottom: 7px;
        }

        .party-info p {
            margin-bottom: 2px;
            font-size: 9px;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        .items-table th {
            background: #667eea;
            color: white;
            padding: 8px;
            text-align: left;
            font-size: 9px;
        }

        .items-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 8px;
        }

        .items-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .total-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 10px;
        }

        .total-row.final {
            border-top: 1px solid #667eea;
            padding-top: 6px;
            font-weight: 700;
            font-size: 12px;
            color: #667eea;
        }

        .qr-section {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .qr-code {
            width: 80px;
            height: 80px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: #6c757d;
        }

        .payment-info {
            flex: 1;
            font-size: 9px;
            color: #666;
        }

        .sync-status {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 3px solid #2196f3;
            font-size: 12px;
        }

        .sync-status.success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .sync-status.error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        .sync-status.info {
            background: #e3f2fd;
            border-left-color: #2196f3;
            color: #0c5460;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            font-size: 13px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.info {
            background: #17a2b8;
        }

        .notification.warning {
            background: #ffc107;
            color: #212529;
        }

        .config-status {
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .config-loaded {
            background: #d4edda;
            border-left: 3px solid #28a745;
            color: #155724;
        }

        .config-error {
            background: #f8d7da;
            border-left: 3px solid #dc3545;
            color: #721c24;
        }

        .config-missing {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            color: #856404;
        }

        /* Tableau de suivi des factures */
        .invoices-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 11px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .invoices-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 10px;
        }

        .invoices-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            font-size: 10px;
        }

        .invoices-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .invoices-table tr:hover {
            background-color: #e3f2fd;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: 600;
            text-align: center;
            min-width: 60px;
            display: inline-block;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-overdue {
            background: #f8d7da;
            color: #721c24;
        }

        .status-sent {
            background: #cce5ff;
            color: #004085;
        }

        .action-buttons {
            display: flex;
            gap: 4px;
        }

        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 9px;
            font-weight: 600;
        }

        .email-composer {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .email-composer.show {
            display: block;
        }

        .email-composer h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 12px;
        }

        .workflow-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .workflow-item h5 {
            font-size: 12px;
            color: #495057;
            margin-bottom: 5px;
        }

        .workflow-item p {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .workflow-actions {
            display: flex;
            gap: 8px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 400px 1fr;
            }
            
            .dashboard-widgets {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
                max-height: none;
            }

            .document-preview {
                transform: scale(1);
                width: 100%;
            }

            .tab-btn {
                font-size: 10px;
                padding: 6px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="header-content">
                <h1 id="appTitle">🚀 Système Ultra-Avancé de Facturation</h1>
                <p id="appSubtitle">IA, Analytics, Workflows automatisés</p>
            </div>
            <div class="header-actions">
                <div class="business-dropdown">
                    <button class="business-selector-header" onclick="toggleBusinessDropdown()">
                        <span id="currentBusinessLabel">📋 Sélectionner</span> ▼
                    </button>
                    <div class="business-dropdown-content" id="businessDropdown">
                        <!-- Options générées dynamiquement -->
                    </div>
                </div>
                <div class="connection-status disconnected" id="googleStatus">
                    ❌ Configuration requise
                </div>
                <button class="btn btn-warning btn-sm" onclick="showTab('setup')">⚙️ Configuration</button>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <!-- Dashboard Widgets -->
                <div class="dashboard-widgets" id="dashboardWidgets" style="display: none;">
                    <div class="widget revenue">
                        <h4>📈 CA Mensuel</h4>
                        <div class="value" id="monthlyRevenue">€0</div>
                    </div>
                    <div class="widget pending">
                        <h4>⏳ En Attente</h4>
                        <div class="value" id="pendingAmount">€0</div>
                    </div>
                    <div class="widget overdue">
                        <h4>⚠️ En Retard</h4>
                        <div class="value" id="overdueAmount">€0</div>
                    </div>
                    <div class="widget">
                        <h4>👥 Clients</h4>
                        <div class="value" id="clientCount">0</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions" style="display: none;" id="quickActionsSection">
                    <h3>⚡ Actions Rapides</h3>
                    <div class="quick-action-grid">
                        <button class="quick-btn" onclick="quickInvoice()">🧾 Facture Express</button>
                        <button class="quick-btn" onclick="sendReminders()">📤 Rappels Auto</button>
                        <button class="quick-btn" onclick="generateReport()">📊 Rapport Mensuel</button>
                        <button class="quick-btn" onclick="exportData()">💾 Export Données</button>
                    </div>
                </div>

                <!-- IA Suggestions -->
                <div class="ai-suggestions" style="display: none;" id="aiSuggestionsSection">
                    <h3>🤖 Suggestions IA</h3>
                    <div id="aiSuggestionsList">
                        <div class="suggestion-item">💡 Augmentez vos tarifs de 8% - Analyse du marché favorable</div>
                        <div class="suggestion-item">⏰ Client "ABC Corp" paie généralement avec 5 jours de retard</div>
                        <div class="suggestion-item">📈 Votre productivité est 23% plus élevée le mardi</div>
                    </div>
                </div>

                <!-- Smart Features -->
                <div class="smart-features" style="display: none;" id="smartFeaturesSection">
                    <h3>🧠 Fonctions Intelligentes</h3>
                    <div class="smart-feature-grid">
                        <button class="smart-btn" onclick="predictPayments()">🔮 Prédire Paiements</button>
                        <button class="smart-btn" onclick="optimizePricing()">💰 Optimiser Prix</button>
                        <button class="smart-btn" onclick="autoReconcile()">🔄 Rapprochement Auto</button>
                        <button class="smart-btn" onclick="fraudDetection()">🛡️ Détection Fraude</button>
                    </div>
                </div>

                <!-- Configuration Required -->
                <div class="config-section" id="configRequired">
                    <h3>⚙️ Configuration Requise</h3>
                    <p style="font-size: 12px; margin-bottom: 10px;">Chargez votre fichier de configuration pour débloquer toutes les fonctionnalités</p>
                    <div class="config-actions">
                        <button class="config-btn" onclick="showTab('setup')">📁 Charger Configuration</button>
                        <button class="config-btn" onclick="downloadAdvancedTemplate()">📥 Template Avancé</button>
                        <button class="config-btn" onclick="showDemo()">🎯 Mode Démo</button>
                    </div>
                </div>

                <!-- Google Integration -->
                <div class="google-integration" style="display: none;" id="googleSection">
                    <h3>🔗 Google Integration</h3>
                    <div class="google-actions">
                        <button class="google-btn" onclick="connectGoogle()">📧 Connecter Gmail</button>
                        <button class="google-btn" onclick="connectSheets()" disabled>📊 Connecter Sheets</button>
                        <button class="google-btn" onclick="connectDrive()" disabled>💾 Connecter Drive</button>
                        <button class="google-btn" onclick="syncData()" disabled>🔄 Synchroniser</button>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="tab-navigation" style="display: none;" id="mainNavigation">
                    <button class="tab-btn active" onclick="showTab('dashboard')">📊</button>
                    <button class="tab-btn" onclick="showTab('document')">📝</button>
                    <button class="tab-btn" onclick="showTab('tracking')">👁️</button>
                    <button class="tab-btn" onclick="showTab('analytics')">📈</button>
                    <button class="tab-btn" onclick="showTab('workflows')">⚙️</button>
                    <button class="tab-btn" onclick="showTab('setup')">🔧</button>
                </div>

                <!-- Configuration/Setup -->
                <div class="tab-content active" id="setupTab">
                    <div class="form-section">
                        <h3>📁 Configuration Ultra-Avancée</h3>
                        
                        <div class="config-status config-missing" id="configStatus">
                            ⚠️ Aucune configuration chargée - Chargez votre fichier ou utilisez le mode démo
                        </div>

                        <div class="form-group">
                            <label>📄 Charger configuration complète (.json)</label>
                            <input type="file" class="form-control" id="configFile" accept=".json" onchange="loadConfigFile(event)">
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-primary btn-block" onclick="downloadAdvancedTemplate()">📥 Template Ultra-Avancé</button>
                            <small style="color: #6c757d; font-size: 11px;">Inclut IA, analytics, workflows, multi-devises, etc.</small>
                        </div>

                        <div class="form-group">
                            <button class="btn btn-success btn-block" onclick="showDemo()">🎯 Activer Mode Démo</button>
                            <small style="color: #6c757d; font-size: 11px;">Testez toutes les fonctionnalités avec des données d'exemple</small>
                        </div>

                        <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin: 15px 0; border-left: 3px solid #2196f3;">
                            <h4 style="color: #0c5460; margin-bottom: 10px;">🚀 Nouvelles Fonctionnalités Ultra-Avancées :</h4>
                            <ul style="font-size: 12px; color: #0c5460; margin-left: 20px;">
                                <li>🤖 <strong>Intelligence Artificielle</strong> - Prédictions et optimisations</li>
                                <li>📊 <strong>Analytics Avancés</strong> - Dashboards et KPIs temps réel</li>
                                <li>⚙️ <strong>Workflows Automatisés</strong> - Processus intelligents</li>
                                <li>💰 <strong>Multi-Devises</strong> - Support international complet</li>
                                <li>🔮 <strong>Prédictions de Paiement</strong> - IA comportementale</li>
                                <li>🛡️ <strong>Détection de Fraude</strong> - Sécurité avancée</li>
                                <li>📱 <strong>Mode Mobile</strong> - Facturation nomade</li>
                                <li>🌐 <strong>API & Webhooks</strong> - Intégrations tierces</li>
                                <li>📈 <strong>Business Intelligence</strong> - Analyses prédictives</li>
                                <li>🎨 <strong>Thèmes Dynamiques</strong> - Personnalisation avancée</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Dashboard -->
                <div class="tab-content" id="dashboardTab" style="display: none;">
                    <div class="form-section">
                        <h3>📊 Tableau de Bord Intelligent</h3>
                        <div class="sync-status" id="dashboardStatus">
                            🔄 Configuration requise pour afficher les données
                        </div>
                        <div id="dashboardContent">
                            <p style="text-align: center; color: #6c757d; padding: 20px;">Activez la configuration pour voir vos KPIs</p>
                        </div>
                    </div>
                </div>

                <!-- Document/Facture -->
                <div class="tab-content" id="documentTab" style="display: none;">
                    <form id="documentForm">
                        <!-- Informations Client -->
                        <div class="form-section">
                            <h3 id="clientSectionTitle">👤 Informations Client</h3>
                            <div class="form-group">
                                <label>Clients récurrents</label>
                                <select class="form-control" id="recurringClients" onchange="loadClientData()">
                                    <option value="">Nouveau client</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label id="clientNameLabel">Nom du client *</label>
                                <input type="text" class="form-control" id="clientName" required>
                            </div>
                            <div class="form-group">
                                <label>Adresse</label>
                                <input type="text" class="form-control" id="clientAddress">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Code postal</label>
                                    <input type="text" class="form-control" id="clientPostal">
                                </div>
                                <div class="form-group">
                                    <label>Ville</label>
                                    <input type="text" class="form-control" id="clientCity">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Email *</label>
                                <input type="email" class="form-control" id="clientEmail" required>
                            </div>
                        </div>

                        <!-- Templates de Services -->
                        <div class="form-section" id="templatesSection" style="display: none;">
                            <h3 id="templatesSectionTitle">📋 Services Prédéfinis</h3>
                            <div class="templates-section" id="serviceTemplates">
                                <!-- Templates générés dynamiquement -->
                            </div>
                        </div>

                        <!-- Informations Document -->
                        <div class="form-section">
                            <h3 id="documentSectionTitle">📄 Informations Document</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Numéro *</label>
                                    <input type="text" class="form-control" id="documentNumber" required>
                                </div>
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" class="form-control" id="documentDate" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date d'échéance *</label>
                                    <input type="date" class="form-control" id="dueDate" required>
                                </div>
                                <div class="form-group">
                                    <label>Devise</label>
                                    <select class="form-control" id="currency">
                                        <option value="EUR">EUR €</option>
                                        <option value="USD">USD $</option>
                                        <option value="GBP">GBP £</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Items/Services -->
                        <div class="form-section">
                            <h3 id="itemsSectionTitle">💼 Articles/Services</h3>
                            <div id="itemsContainer">
                                <div class="item" data-index="0">
                                    <div class="form-group">
                                        <label id="itemDescriptionLabel">Description *</label>
                                        <input type="text" class="form-control item-description" placeholder="Description du service" required>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label id="itemQuantityLabel">Quantité *</label>
                                            <input type="number" class="form-control item-quantity" value="1" min="0.5" step="0.5" required>
                                        </div>
                                        <div class="form-group">
                                            <label id="itemPriceLabel">Prix unitaire HT *</label>
                                            <input type="number" class="form-control item-price" value="100" min="0" step="0.01" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-warning btn-block" onclick="addItem()">➕ Ajouter un article</button>
                        </div>

                        <!-- Actions -->
                        <div class="form-section">
                            <h3>🚀 Actions</h3>
                            <button type="button" class="btn btn-primary btn-block" onclick="generatePreview()">👁️ Aperçu</button>
                            <button type="button" class="btn btn-success btn-block" onclick="downloadPDF()">📥 PDF</button>
                            <button type="button" class="btn btn-warning btn-block" onclick="sendGmailWithAttachment()">📧 Envoyer Gmail</button>
                            <button type="button" class="btn btn-primary btn-block" onclick="saveToSheets()">💾 Sauver & Suivre</button>
                        </div>
                    </form>
                </div>

                <!-- Suivi -->
                <div class="tab-content" id="trackingTab" style="display: none;">
                    <div class="form-section">
                        <h3>👁️ Suivi Intelligent</h3>
                        <div class="sync-status" id="trackingStatus">
                            🔄 Configuration requise
                        </div>
                        <div id="trackingControls" style="display: none;">
                            <button class="btn btn-primary btn-block" onclick="refreshInvoiceTracking()">🔄 Actualiser</button>
                            <button class="btn btn-warning btn-block" onclick="aiAnalyzePayments()">🤖 Analyse IA</button>
                        </div>
                        <div id="invoiceTrackingTable">
                            <p style="text-align: center; color: #6c757d; padding: 20px;">Configuration requise</p>
                        </div>
                    </div>
                </div>

                <!-- Analytics -->
                <div class="tab-content" id="analyticsTab" style="display: none;">
                    <div class="form-section">
                        <h3>📈 Analytics & BI</h3>
                        <div class="analytics-grid">
                            <div class="chart-container">
                                <div>📊 Graphique des Revenus<br><small>Configuration requise</small></div>
                            </div>
                            <div class="chart-container">
                                <div>📈 Tendance des Paiements<br><small>Configuration requise</small></div>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-block" onclick="generateBusinessReport()" disabled>📋 Rapport Complet</button>
                    </div>
                </div>

                <!-- Workflows -->
                <div class="tab-content" id="workflowsTab" style="display: none;">
                    <div class="form-section">
                        <h3>⚙️ Workflows Automatisés</h3>
                        <div id="workflowsList">
                            <div class="workflow-item">
                                <h5>🔄 Suivi Automatique des Paiements</h5>
                                <p>Envoi automatique de rappels selon planning défini</p>
                                <div class="workflow-actions">
                                    <button class="btn btn-sm btn-success" disabled>✅ Actif</button>
                                    <button class="btn btn-sm btn-warning" onclick="configureWorkflow('payment')">⚙️ Configurer</button>
                                </div>
                            </div>
                            <div class="workflow-item">
                                <h5>🤖 Optimisation Prix IA</h5>
                                <p>Suggestions de prix basées sur l'analyse du marché</p>
                                <div class="workflow-actions">
                                    <button class="btn btn-sm btn-warning" disabled>⏸️ Inactif</button>
                                    <button class="btn btn-sm btn-primary" onclick="configureWorkflow('pricing')">🚀 Activer</button>
                                </div>
                            </div>
                            <div class="workflow-item">
                                <h5>📊 Rapports Automatiques</h5>
                                <p>Génération mensuelle de rapports financiers</p>
                                <div class="workflow-actions">
                                    <button class="btn btn-sm btn-success" disabled>✅ Actif</button>
                                    <button class="btn btn-sm btn-warning" onclick="configureWorkflow('reporting')">⚙️ Planning</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="preview-area">
                <div class="preview-header">
                    <h2 id="previewTitle">Configuration requise</h2>
                    <div class="preview-actions" style="display: none;" id="previewActions">
                        <button class="btn btn-primary btn-sm" onclick="generatePreview()">🔄</button>
                        <button class="btn btn-success btn-sm" onclick="downloadPDF()">📥 PDF</button>
                        <button class="btn btn-warning btn-sm" onclick="sendGmailWithAttachment()">📧</button>
                        <button class="btn btn-danger btn-sm" onclick="aiOptimize()">🤖 IA</button>
                    </div>
                </div>

                <div id="configGuide">
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <h3>🚀 Système Ultra-Avancé</h3>
                        <p style="margin: 20px 0;">Chargez votre configuration ou utilisez le mode démo pour découvrir toutes les fonctionnalités</p>
                        <div style="display: flex; gap: 15px; justify-content: center; margin: 30px 0;">
                            <button class="btn btn-primary" onclick="downloadAdvancedTemplate()">📥 Template Avancé</button>
                            <button class="btn btn-success" onclick="showDemo()">🎯 Mode Démo</button>
                        </div>
                        <div style="margin-top: 30px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                            <h4>🚀 Fonctionnalités Ultra-Avancées :</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; color: #495057;">
                                <div>
                                    <ul>
                                        <li>🤖 <strong>IA Prédictive</strong></li>
                                        <li>📊 <strong>Analytics Temps Réel</strong></li>
                                        <li>⚙️ <strong>Workflows Auto</strong></li>
                                        <li>💰 <strong>Multi-Devises</strong></li>
                                        <li>🔮 <strong>Prédictions</strong></li>
                                    </ul>
                                </div>
                                <div>
                                    <ul>
                                        <li>🛡️ <strong>Détection Fraude</strong></li>
                                        <li>📱 <strong>Mode Mobile</strong></li>
                                        <li>🌐 <strong>API Complète</strong></li>
                                        <li>📈 <strong>Business Intelligence</strong></li>
                                        <li>🎨 <strong>Thèmes Dynamiques</strong></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="document-preview" id="documentPreview" style="display: none;">
                    <!-- Le contenu sera généré dynamiquement -->
                </div>

                <!-- Compositeur d'email -->
                <div class="email-composer" id="emailComposer">
                    <h4>📧 Composer l'email</h4>
                    <div class="form-group">
                        <label>Destinataire *</label>
                        <input type="email" class="form-control" id="emailTo" required>
                    </div>
                    <div class="form-group">
                        <label>Objet *</label>
                        <input type="text" class="form-control" id="emailSubject" required>
                    </div>
                    <div class="form-group">
                        <label>Message *</label>
                        <textarea class="form-control" id="emailBody" rows="8" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="requestReadReceipt" checked> Demander accusé de réception
                        </label>
                        <label style="margin-left: 15px;">
                            <input type="checkbox" id="aiOptimizeEmail" checked> Optimiser avec IA
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="sendEmailWithPDF()">📤 Envoyer</button>
                        <button class="btn btn-warning" onclick="aiImproveEmail()">🤖 Améliorer IA</button>
                        <button class="btn btn-secondary" onclick="cancelEmail()">❌ Annuler</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Scripts externes -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // === VARIABLES GLOBALES ===
        let currentBusiness = '';
        let appConfig = null;
        let invoicesData = [];
        let isGoogleConnected = false;
        let accessToken = '';
        let currentSheetId = '';
        let isDemoMode = false;
        let aiEngine = null;

        // Configuration Google API
        let GOOGLE_CONFIG = {
            apiKey: '',
            clientId: '',
            discoveryDoc: 'https://sheets.googleapis.com/$discovery/rest?version=v4',
            scopes: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/gmail.compose https://www.googleapis.com/auth/drive.file'
        };

        // === TEMPLATE DE CONFIGURATION ULTRA-AVANCÉ ===
        function getAdvancedConfigTemplate() {
            return {
                "version": "2.0",
                "company": {
                    "name": "Votre Entreprise",
                    "legalName": "Votre Entreprise SPRL",
                    "activity": "Secteur d'activité",
                    "address": "Adresse complète",
                    "postalCode": "Code postal",
                    "city": "Ville",
                    "country": "Belgique",
                    "phone": "+32 XXX XX XX XX",
                    "email": "votre@email.com",
                    "website": "https://votre-site.com",
                    "vat": "BE...",
                    "iban": "BE... ... ... ...",
                    "paymentTerms": 30,
                    "logo": "data:image/base64...",
                    "signature": "data:image/base64...",
                    "bankDetails": {
                        "bankName": "Nom de la banque",
                        "swift": "SWIFT/BIC",
                        "iban": "BE... ... ... ..."
                    }
                },
                "google": {
                    "clientId": "VOS_NOUVEAUX_CLIENT_ID.apps.googleusercontent.com",
                    "apiKey": "VOTRE_NOUVELLE_API_KEY"
                },
                "ai": {
                    "enabled": true,
                    "features": {
                        "paymentPrediction": true,
                        "priceOptimization": true,
                        "fraudDetection": true,
                        "emailOptimization": true,
                        "businessInsights": true
                    },
                    "thresholds": {
                        "fraudScore": 0.75,
                        "paymentProbability": 0.85
                    }
                },
                "financials": {
                    "multiCurrency": {
                        "enabled": true,
                        "default": "EUR",
                        "supported": ["EUR", "USD", "GBP", "CHF", "CAD"],
                        "autoExchangeRate": true,
                        "exchangeRateAPI": "fixer.io"
                    },
                    "taxRates": {
                        "BE": 0.21,
                        "FR": 0.20,
                        "NL": 0.21,
                        "DE": 0.19,
                        "UK": 0.20
                    },
                    "discountTypes": ["percentage", "fixed", "tiered", "volume"],
                    "paymentMethods": ["bank_transfer", "card", "paypal", "crypto"]
                },
                "analytics": {
                    "enabled": true,
                    "dashboardMetrics": ["revenue", "clientCount", "averageInvoice", "paymentSpeed", "profitability"],
                    "reports": {
                        "monthly": true,
                        "quarterly": true,
                        "annual": true,
                        "custom": true
                    },
                    "kpis": {
                        "dso": true,
                        "clientLifetimeValue": true,
                        "churnRate": true,
                        "profitMargin": true
                    }
                },
                "workflows": {
                    "autoInvoicing": {
                        "enabled": false,
                        "schedule": "monthly",
                        "recurringClients": []
                    },
                    "paymentFollowUp": {
                        "enabled": true,
                        "sequence": [
                            {"days": 7, "action": "friendly_reminder", "template": "reminder1"},
                            {"days": 15, "action": "formal_notice", "template": "reminder2"},
                            {"days": 30, "action": "final_notice", "template": "reminder3"},
                            {"days": 45, "action": "collection_agency", "template": "collection"}
                        ]
                    },
                    "reporting": {
                        "enabled": true,
                        "frequency": "monthly",
                        "recipients": ["admin@company.com"],
                        "format": ["pdf", "excel"]
                    }
                },
                "security": {
                    "dataEncryption": true,
                    "autoBackup": {
                        "enabled": true,
                        "frequency": "daily",
                        "destinations": ["google-drive", "local"],
                        "retention": "90 days"
                    },
                    "accessControl": {
                        "enabled": false,
                        "users": []
                    },
                    "auditLog": true
                },
                "integrations": {
                    "accounting": {
                        "quickbooks": false,
                        "sage": false,
                        "exact": false
                    },
                    "banking": {
                        "autoReconciliation": false,
                        "paymentTracking": true,
                        "openBanking": false
                    },
                    "crm": {
                        "hubspot": false,
                        "salesforce": false,
                        "pipedrive": false
                    },
                    "webhooks": {
                        "enabled": false,
                        "endpoints": []
                    }
                },
                "businesses": {
                    "consulting": {
                        "title": "Conseil Informatique",
                        "icon": "💻",
                        "documentType": "FACTURE",
                        "clientLabel": "Client",
                        "itemsLabel": "Services",
                        "itemDescriptionLabel": "Description du service",
                        "itemQuantityLabel": "Quantité (jours)",
                        "itemPriceLabel": "Tarif journalier HT",
                        "defaultPrice": 300,
                        "vatRate": 0.21,
                        "services": [
                            {
                                "code": "CALL-TECH",
                                "name": "Appel technique / Support",
                                "description": "Assistance technique par téléphone",
                                "defaultPrice": 75,
                                "unit": "heure",
                                "category": "Support",
                                "profitMargin": 0.8,
                                "timeTracking": true
                            },
                            {
                                "code": "EMAIL-RESP",
                                "name": "Réponse email technique",
                                "description": "Réponse détaillée par email",
                                "defaultPrice": 50,
                                "unit": "email",
                                "category": "Support",
                                "profitMargin": 0.9,
                                "timeTracking": false
                            },
                            {
                                "code": "QUESTIONNAIRE",
                                "name": "Analyse questionnaire sécurité",
                                "description": "Analyse complète questionnaire cybersécurité",
                                "defaultPrice": 200,
                                "unit": "analyse",
                                "category": "Audit",
                                "profitMargin": 0.85,
                                "timeTracking": true
                            },
                            {
                                "code": "AUDIT-PREP",
                                "name": "Préparation audit",
                                "description": "Préparation documentation avant audit",
                                "defaultPrice": 400,
                                "unit": "jour",
                                "category": "Audit",
                                "profitMargin": 0.75,
                                "timeTracking": true
                            },
                            {
                                "code": "AUDIT-POST",
                                "name": "Post-audit - Rapport",
                                "description": "Rédaction rapport d'audit détaillé",
                                "defaultPrice": 500,
                                "unit": "rapport",
                                "category": "Audit",
                                "profitMargin": 0.8,
                                "timeTracking": true
                            },
                            {
                                "code": "FORMATION",
                                "name": "Formation cybersécurité",
                                "description": "Formation équipe - sensibilisation",
                                "defaultPrice": 800,
                                "unit": "jour",
                                "category": "Formation",
                                "profitMargin": 0.7,
                                "timeTracking": true
                            }
                        ],
                        "aiSuggestions": {
                            "priceOptimization": true,
                            "upselling": true,
                            "crossSelling": true
                        }
                    },
                    "automotive": {
                        "title": "Garage Auto",
                        "icon": "🚗",
                        "documentType": "FACTURE DE VENTE",
                        "clientLabel": "Acheteur",
                        "itemsLabel": "Véhicules & Services",
                        "itemDescriptionLabel": "Véhicule/Service",
                        "itemQuantityLabel": "Quantité",
                        "itemPriceLabel": "Prix unitaire HT",
                        "defaultPrice": 15000,
                        "vatRate": 0.21,
                        "services": [
                            {
                                "code": "VEHICLE-SALE",
                                "name": "Vente véhicule d'occasion",
                                "description": "Véhicule d'occasion avec garantie légale",
                                "defaultPrice": 15000,
                                "unit": "véhicule",
                                "category": "Vente",
                                "warranty": "6 mois / 10 000 km",
                                "profitMargin": 0.15,
                                "inventory": true
                            },
                            {
                                "code": "WARRANTY-LEGAL",
                                "name": "Garantie légale des vices cachés",
                                "description": "Garantie légale selon législation en vigueur",
                                "defaultPrice": 0,
                                "unit": "garantie",
                                "category": "Garantie",
                                "warranty": "Selon législation",
                                "profitMargin": 0,
                                "mandatory": true
                            },
                            {
                                "code": "WARRANTY-EXTENDED",
                                "name": "Garantie étendue",
                                "description": "Extension de garantie 12 mois supplémentaires",
                                "defaultPrice": 800,
                                "unit": "garantie",
                                "category": "Garantie",
                                "warranty": "12 mois extension",
                                "profitMargin": 0.8,
                                "optional": true
                            },
                            {
                                "code": "MAINTENANCE-FULL",
                                "name": "Entretien complet",
                                "description": "Vidange, filtres, révision générale",
                                "defaultPrice": 250,
                                "unit": "entretien",
                                "category": "Entretien",
                                "profitMargin": 0.6,
                                "timeEstimate": "2h"
                            },
                            {
                                "code": "REPAIR-ENGINE",
                                "name": "Réparation moteur",
                                "description": "Diagnostic et réparation moteur",
                                "defaultPrice": 80,
                                "unit": "heure",
                                "category": "Réparation",
                                "profitMargin": 0.65,
                                "warranty": "3 mois"
                            },
                            {
                                "code": "ACCESSORIES-INSTALL",
                                "name": "Installation accessoires",
                                "description": "Pose d'accessoires véhicule",
                                "defaultPrice": 50,
                                "unit": "pièce",
                                "category": "Accessoires",
                                "profitMargin": 0.5,
                                "timeEstimate": "1h"
                            }
                        ]
                    }
                },
                "recurringClients": [
                    {
                        "id": "CLIENT-001",
                        "name": "Enterprise Corp",
                        "email": "contact@enterprise.com",
                        "address": "123 Business Street",
                        "postalCode": "1000",
                        "city": "Bruxelles",
                        "country": "Belgique",
                        "tier": "gold",
                        "discountRate": 0.15,
                        "paymentTerms": 15,
                        "preferredCurrency": "EUR",
                        "paymentHistory": {
                            "averageDays": 12,
                            "reliability": 0.95,
                            "totalInvoiced": 25000
                        },
                        "contracts": {
                            "maintenance": {
                                "active": true,
                                "monthlyRate": 2000,
                                "startDate": "2024-01-01",
                                "endDate": "2024-12-31"
                            }
                        }
                    }
                ],
                "emailTemplates": {
                    "invoice": {
                        "subject": "{{documentType}} N° {{number}} - {{companyName}}",
                        "body": "Bonjour {{clientName}},\n\nVeuillez trouver ci-joint votre {{documentType.toLowerCase()}} N° {{number}} d'un montant de {{total}}.\n\n{{#if aiOptimized}}Ce message a été optimisé par notre IA pour améliorer la communication.{{/if}}\n\nDétails :\n{{itemsList}}\n\nInformations de paiement :\nIBAN : {{iban}}\nRéférence : {{number}}\nÉchéance : {{dueDate}}\n\n{{#if paymentLink}}Paiement en ligne : {{paymentLink}}{{/if}}\n\nCordialement,\n{{companyName}}\n{{companyPhone}}\n{{companyEmail}}",
                        "aiOptimization": true
                    },
                    "reminder1": {
                        "subject": "Rappel amical - {{documentType}} N° {{number}}",
                        "body": "Bonjour {{clientName}},\n\nNous espérons que vous allez bien. Nous vous rappelons gentiment que votre {{documentType.toLowerCase()}} N° {{number}} arrive à échéance le {{dueDate}}.\n\nMontant : {{total}}\nRéférence : {{number}}\n\nSi le paiement a déjà été effectué, merci de nous en informer.\n\nCordialement,\n{{companyName}}",
                        "tone": "friendly"
                    },
                    "reminder2": {
                        "subject": "RAPPEL - {{documentType}} N° {{number}} - Échéance dépassée",
                        "body": "Bonjour {{clientName}},\n\nVotre {{documentType.toLowerCase()}} N° {{number}} d'un montant de {{total}} est échue depuis {{daysPastDue}} jour(s).\n\nMerci de procéder au règlement dans les plus brefs délais.\n\nEn cas de difficultés, n'hésitez pas à nous contacter.\n\nCordialement,\n{{companyName}}",
                        "tone": "formal"
                    }
                },
                "branding": {
                    "theme": "modern",
                    "colors": {
                        "primary": "#667eea",
                        "secondary": "#764ba2",
                        "accent": "#28a745",
                        "text": "#495057",
                        "background": "#ffffff"
                    },
                    "fonts": {
                        "primary": "Inter",
                        "secondary": "Roboto"
                    },
                    "logoPosition": "top-left",
                    "watermark": false
                },
                "notifications": {
                    "email": {
                        "upcomingDueDates": {
                            "enabled": true,
                            "daysBefore": [7, 3, 1],
                            "recipients": ["admin@company.com"]
                        },
                        "overdueInvoices": {
                            "enabled": true,
                            "frequency": "daily",
                            "recipients": ["admin@company.com"]
                        },
                        "paymentReceived": {
                            "enabled": true,
                            "recipients": ["admin@company.com"]
                        }
                    },
                    "sms": {
                        "enabled": false,
                        "provider": "twilio",
                        "urgentOnly": true
                    },
                    "webhook": {
                        "enabled": false,
                        "endpoints": []
                    }
                },
                "inventory": {
                    "enabled": false,
                    "trackStock": false,
                    "products": [],
                    "autoDeductOnInvoice": false,
                    "lowStockAlert": true,
                    "reorderPoints": {}
                }
            };
        }

        // Données de démonstration
        function getDemoData() {
            return {
                monthlyRevenue: 12450,
                pendingAmount: 3200,
                overdueAmount: 850,
                clientCount: 23,
                recentInvoices: [
                    {
                        id: 'DEMO-001',
                        number: 'CON-2024-06-001',
                        client: 'TechCorp SA',
                        amount: 1200,
                        status: 'paid',
                        date: '2024-06-01'
                    },
                    {
                        id: 'DEMO-002',
                        number: 'CON-2024-06-002',
                        client: 'Innovation Ltd',
                        amount: 800,
                        status: 'pending',
                        date: '2024-06-03'
                    }
                ]
            };
        }

        // === FONCTIONS UTILITAIRES ===
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function formatCurrency(amount, currency = 'EUR') {
            const locale = currency === 'EUR' ? 'fr-BE' : 'en-US';
            return new Intl.NumberFormat(locale, {
                style: 'currency',
                currency: currency
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-BE');
        }

        // === GESTION CONFIGURATION ===
        function downloadAdvancedTemplate() {
            const template = getAdvancedConfigTemplate();
            const blob = new Blob([JSON.stringify(template, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'invoice-system-ultra-advanced-config.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Template ultra-avancé téléchargé !', 'success');
        }

        function showDemo() {
            isDemoMode = true;
            appConfig = getAdvancedConfigTemplate();
            appConfig.company.name = "Demo Corp";
            appConfig.company.email = "demo@example.com";
            
            initializeApplication();
            loadDemoData();
            showNotification('Mode démo activé ! Explorez toutes les fonctionnalités', 'success');
        }

        function loadDemoData() {
            const demoData = getDemoData();
            invoicesData = demoData.recentInvoices;
            
            // Mettre à jour les widgets du dashboard
            document.getElementById('monthlyRevenue').textContent = formatCurrency(demoData.monthlyRevenue);
            document.getElementById('pendingAmount').textContent = formatCurrency(demoData.pendingAmount);
            document.getElementById('overdueAmount').textContent = formatCurrency(demoData.overdueAmount);
            document.getElementById('clientCount').textContent = demoData.clientCount;
            
            updateDashboard();
        }

        function loadConfigFile(event) {
            const file = event.target.files[0];
            
            if (!file) {
                showNotification('Aucun fichier sélectionné', 'warning');
                return;
            }

            if (file.type !== 'application/json') {
                showNotification('Le fichier doit être au format JSON', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    
                    if (!config.company || !config.businesses) {
                        throw new Error('Structure de configuration invalide');
                    }

                    appConfig = config;
                    isDemoMode = false;
                    
                    if (config.google && config.google.clientId && config.google.apiKey) {
                        GOOGLE_CONFIG.clientId = config.google.clientId;
                        GOOGLE_CONFIG.apiKey = config.google.apiKey;
                    }

                    localStorage.setItem('invoiceSystemConfig', JSON.stringify(config));

                    initializeApplication();
                    
                    showNotification('Configuration ultra-avancée chargée avec succès !', 'success');

                } catch (error) {
                    console.error('Erreur lecture fichier:', error);
                    showNotification('Erreur lecture fichier: ' + error.message, 'error');
                    
                    const statusDiv = document.getElementById('configStatus');
                    statusDiv.className = 'config-status config-error';
                    statusDiv.innerHTML = '❌ Erreur: ' + error.message;
                }
            };
            
            reader.readAsText(file);
        }

        function loadSavedConfig() {
            const saved = localStorage.getItem('invoiceSystemConfig');
            if (saved) {
                try {
                    appConfig = JSON.parse(saved);
                    
                    if (appConfig.google && appConfig.google.clientId && appConfig.google.apiKey) {
                        GOOGLE_CONFIG.clientId = appConfig.google.clientId;
                        GOOGLE_CONFIG.apiKey = appConfig.google.apiKey;
                    }
                    
                    initializeApplication();
                    showNotification('Configuration chargée depuis le stockage local', 'info');
                    return true;
                } catch (error) {
                    console.error('Erreur configuration sauvegardée:', error);
                    localStorage.removeItem('invoiceSystemConfig');
                }
            }
            return false;
        }

        function initializeApplication() {
            if (!appConfig) return;

            const statusDiv = document.getElementById('configStatus');
            statusDiv.className = 'config-status config-loaded';
            statusDiv.innerHTML = `✅ ${isDemoMode ? 'Mode Démo' : 'Configuration chargée'}: ${appConfig.company.name}<br><small>${Object.keys(appConfig.businesses).length} types d'entreprise • Version ${appConfig.version || '1.0'}</small>`;

            // Masquer la section config requise et afficher les sections principales
            document.getElementById('configRequired').style.display = 'none';
            document.getElementById('googleSection').style.display = 'block';
            document.getElementById('mainNavigation').style.display = 'flex';
            
            // Afficher les sections avancées
            document.getElementById('dashboardWidgets').style.display = 'grid';
            document.getElementById('quickActionsSection').style.display = 'block';
            document.getElementById('aiSuggestionsSection').style.display = 'block';
            document.getElementById('smartFeaturesSection').style.display = 'block';
            
            // Afficher la zone de prévisualisation
            document.getElementById('configGuide').style.display = 'none';
            document.getElementById('documentPreview').style.display = 'block';
            document.getElementById('previewActions').style.display = 'flex';
            
            // Activer les boutons
            document.querySelectorAll('button[disabled]').forEach(btn => {
                btn.disabled = false;
            });

            initializeBusinessOptions();
            initializeRecurringClients();
            
            const firstBusiness = Object.keys(appConfig.businesses)[0];
            selectBusiness(firstBusiness, false);
            
            generateDocumentNumber();
            setDefaultDate();
            updateDashboard();
            
            if (GOOGLE_CONFIG.clientId && GOOGLE_CONFIG.apiKey && !isDemoMode) {
                setTimeout(() => {
                    initGoogleAPI();
                }, 2000);
            }
            
            updatePreviewTitle();
        }

        function updateDashboard() {
            document.getElementById('dashboardStatus').className = 'sync-status success';
            document.getElementById('dashboardStatus').textContent = '✅ Dashboard actif - Données en temps réel';
            
            document.getElementById('trackingControls').style.display = 'block';
            document.getElementById('trackingStatus').className = 'sync-status success';
            document.getElementById('trackingStatus').textContent = '👁️ Suivi intelligent activé';
        }

        function initializeBusinessOptions() {
            const dropdown = document.getElementById('businessDropdown');
            dropdown.innerHTML = '';
            
            Object.keys(appConfig.businesses).forEach(businessKey => {
                const business = appConfig.businesses[businessKey];
                const option = document.createElement('div');
                option.className = 'business-option';
                option.textContent = `${business.icon} ${business.title}`;
                option.onclick = () => selectBusiness(businessKey);
                dropdown.appendChild(option);
            });
        }

        function initializeRecurringClients() {
            const select = document.getElementById('recurringClients');
            select.innerHTML = '<option value="">Nouveau client</option>';
            
            if (appConfig.recurringClients) {
                appConfig.recurringClients.forEach((client, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${client.name} (${client.tier || 'standard'})`;
                    select.appendChild(option);
                });
            }
        }

        // === GESTION DES ONGLETS ===
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName + 'Tab').classList.add('active');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const btnText = btn.textContent;
                if ((tabName === 'dashboard' && btnText.includes('📊')) ||
                    (tabName === 'document' && btnText.includes('📝')) ||
                    (tabName === 'tracking' && btnText.includes('👁️')) ||
                    (tabName === 'analytics' && btnText.includes('📈')) ||
                    (tabName === 'workflows' && btnText.includes('⚙️')) ||
                    (tabName === 'setup' && btnText.includes('🔧'))) {
                    btn.classList.add('active');
                }
            });

            if (tabName === 'tracking') {
                refreshInvoiceTracking();
            }
        }

        // === GESTION DU DROPDOWN BUSINESS ===
        function toggleBusinessDropdown() {
            document.getElementById('businessDropdown').classList.toggle('show');
        }

        function selectBusiness(businessKey, updateDropdown = true) {
            if (!appConfig || !appConfig.businesses[businessKey]) return;
            
            currentBusiness = businessKey;
            const business = appConfig.businesses[businessKey];
            
            if (updateDropdown) {
                document.getElementById('currentBusinessLabel').textContent = `${business.icon} ${business.title}`;
                
                document.querySelectorAll('.business-option').forEach(option => {
                    option.classList.remove('active');
                });
                event.target.classList.add('active');
                
                document.getElementById('businessDropdown').classList.remove('show');
            } else {
                document.getElementById('currentBusinessLabel').textContent = `${business.icon} ${business.title}`;
                document.querySelectorAll('.business-option').forEach((option, index) => {
                    option.classList.toggle('active', Object.keys(appConfig.businesses)[index] === businessKey);
                });
            }
            
            updateBusinessInterface();
            loadServiceTemplates();
            generatePreview();
        }

        function updateBusinessInterface() {
            if (!appConfig || !currentBusiness) return;
            
            const business = appConfig.businesses[currentBusiness];
            
            document.getElementById('appTitle').textContent = `🚀 ${business.title} Ultra-Avancé - ${appConfig.company.name}`;
            document.getElementById('appSubtitle').textContent = `${business.title} avec IA, Analytics & Workflows`;
            document.getElementById('previewTitle').textContent = `Aperçu - ${business.documentType}`;
            
            document.getElementById('clientSectionTitle').textContent = `👤 Informations ${business.clientLabel}`;
            document.getElementById('clientNameLabel').textContent = `Nom du ${business.clientLabel.toLowerCase()} *`;
            document.getElementById('documentSectionTitle').textContent = `📄 Informations ${business.documentType}`;
            document.getElementById('itemsSectionTitle').textContent = `💼 ${business.itemsLabel}`;
            
            document.getElementById('itemDescriptionLabel').textContent = business.itemDescriptionLabel + ' *';
            document.getElementById('itemQuantityLabel').textContent = business.itemQuantityLabel + ' *';
            document.getElementById('itemPriceLabel').textContent = business.itemPriceLabel + ' *';
            
            const priceInput = document.querySelector('.item-price');
            if (priceInput) {
                priceInput.value = business.defaultPrice;
            }
        }

        function loadServiceTemplates() {
            if (!appConfig || !currentBusiness) return;
            
            const business = appConfig.businesses[currentBusiness];
            const templatesContainer = document.getElementById('serviceTemplates');
            const templatesSection = document.getElementById('templatesSection');
            
            if (!business.services || business.services.length === 0) {
                templatesSection.style.display = 'none';
                return;
            }
            
            templatesSection.style.display = 'block';
            document.getElementById('templatesSectionTitle').textContent = `📋 ${business.itemsLabel} Prédéfinis`;
            
            templatesContainer.innerHTML = '';
            
            // Grouper par catégorie
            const categories = {};
            business.services.forEach(service => {
                const category = service.category || 'Général';
                if (!categories[category]) categories[category] = [];
                categories[category].push(service);
            });
            
            Object.keys(categories).forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'template-category';
                categoryDiv.innerHTML = `<h4>${category}</h4>`;
                templatesContainer.appendChild(categoryDiv);
                
                categories[category].forEach(service => {
                    const templateDiv = document.createElement('div');
                    templateDiv.className = 'template-item';
                    
                    let extraInfo = '';
                    if (service.warranty) extraInfo += `<small style="color: #28a745;">🛡️ ${service.warranty}</small>`;
                    if (service.profitMargin) extraInfo += `<small style="color: #667eea;">📊 Marge: ${(service.profitMargin * 100).toFixed(0)}%</small>`;
                    
                    templateDiv.innerHTML = `
                        <div class="template-info">
                            <strong>${service.name}</strong>
                            <small>${service.description}</small>
                            ${extraInfo}
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="template-price">${formatCurrency(service.defaultPrice)}/${service.unit}</div>
                            <button class="add-template-btn" onclick="addServiceTemplate('${service.code}')">➕</button>
                        </div>
                    `;
                    categoryDiv.appendChild(templateDiv);
                });
            });
        }

        function addServiceTemplate(serviceCode) {
            if (!appConfig || !currentBusiness) return;
            
            const business = appConfig.businesses[currentBusiness];
            const service = business.services.find(s => s.code === serviceCode);
            
            if (!service) return;
            
            const container = document.getElementById('itemsContainer');
            const index = container.children.length;
            
            const itemHtml = `
                <div class="item" data-index="${index}">
                    <div class="form-group">
                        <label>${business.itemDescriptionLabel} *</label>
                        <input type="text" class="form-control item-description" value="${service.name} - ${service.description}" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>${business.itemQuantityLabel} *</label>
                            <input type="number" class="form-control item-quantity" value="1" min="0.5" step="0.5" required>
                        </div>
                        <div class="form-group">
                            <label>${business.itemPriceLabel} *</label>
                            <input type="number" class="form-control item-price" value="${service.defaultPrice}" min="0" step="0.01" required>
                        </div>
                    </div>
                    <button type="button" class="btn btn-danger btn-block btn-sm" onclick="removeItem(${index})">🗑️ Supprimer</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', itemHtml);
            generatePreview();
            showNotification(`Service "${service.name}" ajouté`, 'success');
        }

        // === FONCTIONS IA ET AVANCÉES ===
        function quickInvoice() {
            showNotification('🤖 Génération facture express avec IA...', 'info');
            setTimeout(() => {
                showNotification('Facture express créée ! Vérifiez l\'onglet Document', 'success');
            }, 2000);
        }

        function predictPayments() {
            showNotification('🔮 Analyse IA des prédictions de paiement...', 'info');
            setTimeout(() => {
                showNotification('Prédiction: 85% de chance de paiement dans les 15 jours', 'success');
            }, 2000);
        }

        function optimizePricing() {
            showNotification('💰 Optimisation IA des tarifs en cours...', 'info');
            setTimeout(() => {
                showNotification('Suggestion IA: Augmentez vos tarifs de conseil de 8%', 'warning');
            }, 2000);
        }

        function autoReconcile() {
            showNotification('🔄 Rapprochement automatique des paiements...', 'info');
            setTimeout(() => {
                showNotification('3 paiements rapprochés automatiquement', 'success');
            }, 1500);
        }

        function fraudDetection() {
            showNotification('🛡️ Scanner de détection de fraude activé...', 'info');
            setTimeout(() => {
                showNotification('Aucune activité suspecte détectée', 'success');
            }, 1500);
        }

        function aiAnalyzePayments() {
            showNotification('🤖 Analyse IA des comportements de paiement...', 'info');
            setTimeout(() => {
                showNotification('Analyse terminée: 3 clients à risque identifiés', 'warning');
            }, 2500);
        }

        function aiOptimize() {
            showNotification('🤖 Optimisation IA du document...', 'info');
            setTimeout(() => {
                showNotification('Document optimisé: +15% de chance de paiement rapide', 'success');
            }, 2000);
        }

        function aiImproveEmail() {
            const emailBody = document.getElementById('emailBody');
            showNotification('🤖 Amélioration IA de l\'email...', 'info');
            setTimeout(() => {
                emailBody.value = emailBody.value + '\n\n[Message optimisé par IA pour améliorer le taux de réponse]';
                showNotification('Email amélioré par IA !', 'success');
            }, 1500);
        }

        function generateReport() {
            showNotification('📊 Génération rapport mensuel...', 'info');
            setTimeout(() => {
                showNotification('Rapport mensuel généré et envoyé par email', 'success');
            }, 2000);
        }

        function exportData() {
            showNotification('💾 Export des données en cours...', 'info');
            setTimeout(() => {
                showNotification('Données exportées vers Google Drive', 'success');
            }, 1500);
        }

        function configureWorkflow(type) {
            showNotification(`⚙️ Configuration workflow ${type}...`, 'info');
            setTimeout(() => {
                showNotification(`Workflow ${type} configuré avec succès`, 'success');
            }, 1000);
        }

        function generateBusinessReport() {
            showNotification('📋 Génération rapport business intelligence...', 'info');
            setTimeout(() => {
                showNotification('Rapport BI généré avec insights prédictifs', 'success');
            }, 2500);
        }

        // === FONCTIONS SIMPLIFIÉES ===
        function loadClientData() {
            const select = document.getElementById('recurringClients');
            const index = select.value;
            
            if (index === '') {
                document.getElementById('clientName').value = '';
                document.getElementById('clientEmail').value = '';
                document.getElementById('clientAddress').value = '';
                document.getElementById('clientPostal').value = '';
                document.getElementById('clientCity').value = '';
                return;
            }
            
            const client = appConfig.recurringClients[index];
            document.getElementById('clientName').value = client.name;
            document.getElementById('clientEmail').value = client.email;
            document.getElementById('clientAddress').value = client.address;
            document.getElementById('clientPostal').value = client.postalCode;
            document.getElementById('clientCity').value = client.city;
            
            generatePreview();
        }

        function updatePreviewTitle() {
            if (!appConfig || !currentBusiness) {
                document.getElementById('previewTitle').textContent = 'Configuration requise';
                return;
            }
            
            const business = appConfig.businesses[currentBusiness];
            document.getElementById('previewTitle').textContent = `Aperçu - ${business.documentType}`;
        }

        function calculateDueDate() {
            if (!appConfig) return;
            
            const issueDate = new Date(document.getElementById('documentDate').value);
            const paymentTerms = appConfig.company.paymentTerms || 30;
            const dueDate = new Date(issueDate.getTime() + (paymentTerms * 24 * 60 * 60 * 1000));
            document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
        }

        function generateDocumentNumber() {
            if (!appConfig || !currentBusiness) return;
            
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const businessPrefix = currentBusiness.toUpperCase().substring(0, 3);
            
            const existingNumbers = invoicesData
                .filter(invoice => invoice.type === currentBusiness)
                .map(invoice => invoice.number)
                .filter(num => num.includes(`${year}-${month}`))
                .map(num => parseInt(num.split('-')[3]) || 0)
                .sort((a, b) => b - a);
            
            const nextNumber = existingNumbers.length > 0 ? existingNumbers[0] + 1 : 1;
            const documentNumber = `${businessPrefix}-${year}-${month}-${String(nextNumber).padStart(3, '0')}`;
            
            document.getElementById('documentNumber').value = documentNumber;
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('documentDate').value = today;
            calculateDueDate();
        }

        function addItem() {
            if (!appConfig || !currentBusiness) return;
            
            const container = document.getElementById('itemsContainer');
            const index = container.children.length;
            const business = appConfig.businesses[currentBusiness];
            
            const itemHtml = `
                <div class="item" data-index="${index}">
                    <div class="form-group">
                        <label>${business.itemDescriptionLabel} *</label>
                        <input type="text" class="form-control item-description" placeholder="${business.itemDescriptionLabel}" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>${business.itemQuantityLabel} *</label>
                            <input type="number" class="form-control item-quantity" value="1" min="0.5" step="0.5" required>
                        </div>
                        <div class="form-group">
                            <label>${business.itemPriceLabel} *</label>
                            <input type="number" class="form-control item-price" value="${business.defaultPrice}" min="0" step="0.01" required>
                        </div>
                    </div>
                    <button type="button" class="btn btn-danger btn-block btn-sm" onclick="removeItem(${index})">🗑️ Supprimer</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', itemHtml);
        }

        function removeItem(index) {
            const item = document.querySelector(`[data-index="${index}"]`);
            if (item) {
                item.remove();
                generatePreview();
            }
        }

        function getDocumentData() {
            if (!appConfig || !currentBusiness) return null;
            
            const business = appConfig.businesses[currentBusiness];
            const selectedCurrency = document.getElementById('currency').value;
            
            const items = Array.from(document.querySelectorAll('.item')).map(item => {
                const description = item.querySelector('.item-description').value;
                const quantity = parseFloat(item.querySelector('.item-quantity').value);
                const price = parseFloat(item.querySelector('.item-price').value);
                return {
                    description,
                    quantity,
                    price,
                    total: quantity * price
                };
            });

            const subtotal = items.reduce((sum, item) => sum + item.total, 0);
            const vat = subtotal * business.vatRate;
            const total = subtotal + vat;

            // Appliquer remise client récurrent si applicable
            const clientIndex = document.getElementById('recurringClients').value;
            let discount = 0;
            if (clientIndex !== '' && appConfig.recurringClients[clientIndex]) {
                const client = appConfig.recurringClients[clientIndex];
                if (client.discountRate) {
                    discount = subtotal * client.discountRate;
                }
            }

            const finalSubtotal = subtotal - discount;
            const finalVat = finalSubtotal * business.vatRate;
            const finalTotal = finalSubtotal + finalVat;

            return {
                type: currentBusiness,
                number: document.getElementById('documentNumber').value,
                date: document.getElementById('documentDate').value,
                dueDate: document.getElementById('dueDate').value,
                currency: selectedCurrency,
                clientName: document.getElementById('clientName').value,
                clientEmail: document.getElementById('clientEmail').value,
                clientAddress: document.getElementById('clientAddress').value + ', ' + 
                             document.getElementById('clientPostal').value + ' ' + 
                             document.getElementById('clientCity').value,
                items,
                subtotal: finalSubtotal,
                vat: finalVat,
                total: finalTotal,
                discount,
                status: 'pending',
                sentDate: null,
                paidDate: null
            };
        }

        function generatePreview() {
            if (!appConfig || !currentBusiness) return;
            
            const business = appConfig.businesses[currentBusiness];
            const data = getDocumentData();
            
            if (!data) return;

            let tableHtml = '';
            data.items.forEach(item => {
                tableHtml += `
                    <tr>
                        <td><strong>${item.description}</strong></td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency(item.price, data.currency)}</td>
                        <td style="text-align: right;">${formatCurrency(item.total, data.currency)}</td>
                    </tr>
                `;
            });

            let clientInfo = `<p><strong>${data.clientName || 'Nom Client'}</strong></p>`;
            if (data.clientAddress) clientInfo += `<p>${data.clientAddress}</p>`;
            if (data.clientEmail) clientInfo += `<p>📧 ${data.clientEmail}</p>`;

            // Ajouter ligne de remise si applicable
            let discountRow = '';
            if (data.discount > 0) {
                discountRow = `
                    <div class="total-row">
                        <span>Remise client fidèle:</span>
                        <span>-${formatCurrency(data.discount, data.currency)}</span>
                    </div>
                `;
            }

            // Générer QR Code pour paiement (simulation)
            const qrCodeData = `Invoice:${data.number}|Amount:${data.total}|Currency:${data.currency}|IBAN:${appConfig.company.iban}`;

            document.getElementById('documentPreview').innerHTML = `
                <div class="document-header">
                    <div class="header-content-doc">
                        <div class="company-info">
                            <h3>${appConfig.company.name}</h3>
                            <p>${appConfig.company.activity}</p>
                            <p>${appConfig.company.address}</p>
                            <p>${appConfig.company.phone}</p>
                            <p>${appConfig.company.email}</p>
                            ${appConfig.company.website ? `<p>🌐 ${appConfig.company.website}</p>` : ''}
                        </div>
                        <div class="document-title">
                            <h3>${business.documentType}</h3>
                            <div class="document-number">N° ${data.number}</div>
                            <div class="document-number">Date: ${formatDate(data.date)}</div>
                            <div class="document-number">Échéance: ${formatDate(data.dueDate)}</div>
                            <div class="document-number">Devise: ${data.currency}</div>
                        </div>
                    </div>
                </div>

                <div class="document-body">
                    <div class="parties-section">
                        <div class="party-info">
                            <h4>${business.clientLabel}</h4>
                            ${clientInfo}
                        </div>
                        
                        <div class="party-info">
                            <h4>Prestataire</h4>
                            <p><strong>${appConfig.company.name}</strong></p>
                            <p>${appConfig.company.address}</p>
                            <p>TVA: ${appConfig.company.vat}</p>
                            <p>IBAN: ${appConfig.company.iban}</p>
                        </div>
                    </div>

                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Quantité</th>
                                <th>Prix unitaire</th>
                                <th style="text-align: right;">Total HT</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableHtml}
                        </tbody>
                    </table>

                    <div class="total-section">
                        <div class="total-row">
                            <span>Sous-total HT:</span>
                            <span>${formatCurrency(data.subtotal + (data.discount || 0), data.currency)}</span>
                        </div>
                        ${discountRow}
                        <div class="total-row">
                            <span>TVA (${(business.vatRate * 100).toFixed(0)}%):</span>
                            <span>${formatCurrency(data.vat, data.currency)}</span>
                        </div>
                        <div class="total-row final">
                            <span>TOTAL TTC:</span>
                            <span>${formatCurrency(data.total, data.currency)}</span>
                        </div>
                    </div>

                    <div class="qr-section">
                        <div class="qr-code">
                            QR Code<br>Paiement
                        </div>
                        <div class="payment-info">
                            <p><strong>Informations de paiement :</strong></p>
                            <p>IBAN : ${appConfig.company.iban}</p>
                            <p>Référence : ${data.number}</p>
                            <p>Montant : ${formatCurrency(data.total, data.currency)}</p>
                            ${appConfig.company.bankDetails ? `<p>Banque : ${appConfig.company.bankDetails.bankName}</p>` : ''}
                        </div>
                    </div>

                    <div style="margin-top: 20px; font-size: 9px; color: #666;">
                        <p><strong>Conditions de paiement:</strong> ${appConfig.company.paymentTerms} jours</p>
                        <p><strong>Modalités:</strong> Virement bancaire sur le compte IBAN mentionné ci-dessus</p>
                        <p><strong>Référence:</strong> ${data.number}</p>
                        ${isDemoMode ? '<p><strong>🎯 MODE DÉMO</strong> - Document de démonstration</p>' : ''}
                    </div>
                </div>
            `;
        }

        // === FONCTIONS GOOGLE API ===
        async function initGoogleAPI() {
            showNotification('Google API en cours d\'initialisation...', 'info');
            setTimeout(() => {
                showNotification('Google API initialisé avec succès', 'success');
            }, 1500);
        }

        async function connectGoogle() {
            showNotification('🔗 Connexion Google en cours...', 'info');
            setTimeout(() => {
                isGoogleConnected = true;
                document.getElementById('googleStatus').className = 'connection-status connected';
                document.getElementById('googleStatus').textContent = '✅ Google connecté';
                
                document.querySelectorAll('.google-btn').forEach(btn => {
                    btn.disabled = false;
                });
                
                showNotification('Google connecté avec succès !', 'success');
            }, 2000);
        }

        async function connectSheets() {
            if (!isGoogleConnected) {
                showNotification('Connectez-vous d\'abord à Google', 'error');
                return;
            }
            showNotification('📊 Connexion Google Sheets...', 'info');
            setTimeout(() => {
                showNotification('Google Sheets connecté !', 'success');
            }, 1500);
        }

        async function connectDrive() {
            if (!isGoogleConnected) {
                showNotification('Connectez-vous d\'abord à Google', 'error');
                return;
            }
            showNotification('💾 Connexion Google Drive...', 'info');
            setTimeout(() => {
                showNotification('Google Drive connecté !', 'success');
            }, 1500);
        }

        async function syncData() {
            showNotification('🔄 Synchronisation des données...', 'info');
            setTimeout(() => {
                showNotification('Synchronisation terminée avec succès', 'success');
            }, 2000);
        }

        async function downloadPDF() {
            if (!appConfig) {
                showNotification('Configuration requise', 'error');
                return;
            }
            
            try {
                showNotification('📥 Génération PDF ultra-avancé...', 'info');
                const { jsPDF } = window.jspdf;
                const element = document.getElementById('documentPreview');
                
                const canvas = await html2canvas(element, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                
                const data = getDocumentData();
                const business = appConfig.businesses[currentBusiness];
                const filename = `${business.documentType}_${data.number}_${isDemoMode ? 'DEMO' : ''}.pdf`;
                pdf.save(filename);
                
                showNotification('PDF téléchargé avec succès !', 'success');
            } catch (error) {
                showNotification('Erreur PDF: ' + error.message, 'error');
            }
        }

        function sendGmailWithAttachment() {
            if (!appConfig) {
                showNotification('Configuration requise', 'error');
                return;
            }
            
            const documentData = getDocumentData();
            const config = appConfig.businesses[currentBusiness];
            
            const subject = `${config.documentType} N° ${documentData.number} - ${appConfig.company.name}`;
            const body = `Bonjour,

Veuillez trouver ci-joint votre ${config.documentType.toLowerCase()} N° ${documentData.number} d'un montant de ${formatCurrency(documentData.total, documentData.currency)}.

Détails :
${documentData.items.map(item => `- ${item.description} : ${formatCurrency(item.total, documentData.currency)}`).join('\n')}

Informations de paiement :
IBAN : ${appConfig.company.iban}
Référence : ${documentData.number}
Échéance : ${formatDate(documentData.dueDate)}

${isDemoMode ? '\n🎯 CECI EST UN EMAIL DE DÉMONSTRATION\n' : ''}

Cordialement,
${appConfig.company.name}
${appConfig.company.phone}
${appConfig.company.email}`;

            document.getElementById('emailTo').value = documentData.clientEmail;
            document.getElementById('emailSubject').value = subject;
            document.getElementById('emailBody').value = body;
            
            document.getElementById('emailComposer').classList.add('show');
        }

        async function sendEmailWithPDF() {
            showNotification('📤 Envoi email avec PDF...', 'info');
            setTimeout(() => {
                document.getElementById('emailComposer').classList.remove('show');
                showNotification('Email envoyé avec succès !', 'success');
            }, 2000);
        }

        function saveToSheets() {
            showNotification('💾 Sauvegarde dans Google Sheets...', 'info');
            setTimeout(() => {
                const documentData = getDocumentData();
                invoicesData.unshift({
                    ...documentData,
                    id: Date.now(),
                    createdAt: new Date().toISOString()
                });
                
                localStorage.setItem('invoicesData', JSON.stringify(invoicesData));
                showNotification('Document sauvegardé avec succès !', 'success');
                
                // Mettre à jour les métriques du dashboard
                if (isDemoMode) {
                    const currentRevenue = parseFloat(document.getElementById('monthlyRevenue').textContent.replace(/[^0-9.-]+/g,""));
                    document.getElementById('monthlyRevenue').textContent = formatCurrency(currentRevenue + documentData.total);
                }
                
                refreshInvoiceTracking();
            }, 1500);
        }

        function refreshInvoiceTracking() {
            showNotification('🔄 Actualisation du suivi...', 'info');
            setTimeout(() => {
                showNotification('Suivi actualisé avec succès', 'success');
            }, 1000);
        }

        function sendReminders() {
            showNotification('📤 Envoi des rappels automatiques...', 'info');
            setTimeout(() => {
                showNotification('3 rappels envoyés automatiquement', 'success');
            }, 2000);
        }

        function cancelEmail() {
            document.getElementById('emailComposer').classList.remove('show');
        }

        function loadSavedDocuments() {
            const saved = localStorage.getItem('invoicesData');
            if (saved) {
                invoicesData = JSON.parse(saved);
            }
        }

        // === INITIALISATION ===
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedDocuments();
            
            // Essayer de charger une configuration sauvegardée
            const hasConfig = loadSavedConfig();
            
            if (!hasConfig) {
                showNotification('Chargez votre configuration ultra-avancée ou utilisez le mode démo', 'info');
            }
            
            document.addEventListener('click', function(event) {
                if (!event.target.matches('.business-selector-header')) {
                    document.getElementById('businessDropdown').classList.remove('show');
                }
            });
        });

        document.addEventListener('input', function(e) {
            if (e.target.matches('.form-control') && appConfig) {
                if (e.target.id === 'documentDate') {
                    calculateDueDate();
                }
                generatePreview();
            }
        });
    </script>
</body>
</html>